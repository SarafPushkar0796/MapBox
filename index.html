<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Points on a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>

    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 70px;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body onload="getLocation();">
    <div id='map'></div>
    <p id="data"></p>
    <script type="text/javascript">

      let lat,lon;
      var start = [,];

      // Get 'live' location
      var x = document.getElementById("data");

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else { 
          x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }

      function showPosition(position) {
        x.innerHTML = "Latitude: " + position.coords.latitude + 
        "<br>Longitude: " + position.coords.longitude;

        lat = position.coords.latitude;
        lon = position.coords.longitude;

        // start coord i.e current location
        start = [lat,lon];
        console.log(start);
      }

      function showError(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED:
            x.innerHTML = "User denied the request for Geolocation."
            break;
          case error.POSITION_UNAVAILABLE:
            x.innerHTML = "Location information is unavailable."
            break;
          case error.TIMEOUT:
            x.innerHTML = "The request to get user location timed out."
            break;
          case error.UNKNOWN_ERROR:
            x.innerHTML = "An unknown error occurred."
            break;
        }
      }

      // Map rendering
      mapboxgl.accessToken = 'pk.eyJ1IjoicHVzaGthci1kamFuZ28tbWFwcyIsImEiOiJjazNlMWhtNG0xYjV1M2RzMTBlM2Rnd2dkIn0.l8Q-dN41hMAKJfZ3MhqL-g';

      var map = new mapboxgl.Map({
        container: 'map',

        // style URL
        style: 'mapbox://styles/pushkar-django-maps/ck3jout680jo21co1rwmyxjji', 

        // get the center in 'Dataset' -> 'GeoJSON'
        center: [74.224403,16.694169],
        zoom: 10.7
      });
      
      // Add geolocate control to the map.
      map.addControl(
        new mapboxgl.GeolocateControl({
          positionOptions: {
          enableHighAccuracy: true
          },
          trackUserLocation: true
          var v1 = new mapboxgl.getLngLat();
          console.log(v1);
        })
      );

      // zoom and rotation controls
      map.addControl(new mapboxgl.NavigationControl());

      map.on('click', function(e) {
        var features = map.queryRenderedFeatures(e.point, {

        // replace this with the name of the layer
        layers: ['kolhapur-parking-example'] 
      });

      if (!features.length) {return;}

      var feature = features[0];

      var popup = new mapboxgl.Popup({ offset: [0, -15] })
        .setLngLat(feature.geometry.coordinates)
        .setHTML('<h3>' + feature.properties.title + '</h3><p>' + feature.properties.description + '</p>')
        .addTo(map);
      });

      // initialize the map canvas to interact with later
      var canvas = map.getCanvasContainer();

      var startPos = [16.694,74.225];

      // create a function to make a directions request
      function getRoute(end) {
        // make a directions request
        var url = 'https://api.mapbox.com/directions/v5/mapbox/cycling/' + lat + ',' + lon + ';' + end[0] + ',' + end[1] + '?steps=true&geometries=geojson&access_token=' + mapboxgl.accessToken;

        // make an XHR request https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
        var req = new XMLHttpRequest();
        req.responseType = 'json';
        req.open('GET', url, true);
        req.onload = function() {
          var data = req.response.routes[0];
          var route = data.geometry.coordinates;
          var geojson = {
            type: 'Feature',
            includeGeometry: true, //
            properties: {},
            geometry: {
              type: 'LineString',
              coordinates: route
            }
          };

          // if the route already exists on the map, reset it using setData
          if (map.getSource('route')) {
            map.getSource('route').setData(geojson);
          } else { // otherwise, make a new request
            map.addLayer({
              id: 'route',
              type: 'line',
              includeGeometry: true, //
              source: {
                type: 'geojson',
                data: {
                  type: 'Feature',
                  properties: {},
                  geometry: {
                    type: 'LineString',
                    coordinates: geojson
                  }
                }
              },
              layout: {
                'line-join': 'round',
                'line-cap': 'round'
              },
              paint: {
                'line-color': '#3887be',
                'line-width': 5,
                'line-opacity': 0.75
              }
            });
          }
          
          // add turn instructions here at the end
        };
        req.send();
      }

      map.on('load', function() {
        // make an initial directions request that
        // starts and ends at the same location
        getRoute(start);

        // Add starting point to the map
        map.addLayer({
          id: 'point',
          type: 'circle',
          includeGeometry: true, //
          source: {
            type: 'geojson',
            data: {
            type: 'FeatureCollection',
            features: [{
              type: 'Feature',
              properties: {},
              geometry: {
                type: 'Point',
                coordinates: [start[0],start[1]]
              }
            }]
            }
          },
          paint: {
            'circle-radius': 8,
            'circle-color': '#3887be'
          }
        });
         
        
      });

      map.on('click', function(e) {
          var coordsObj = e.lngLat;
          canvas.style.cursor = '';
          var coords = Object.keys(coordsObj).map(function(key) {
          return coordsObj[key];
          });
          var end = {
            type: 'FeatureCollection',
            includeGeometry: true, //
            features: [{
              type: 'Feature',
              properties: {},
              geometry: {
                type: 'Point',
                coordinates: coords
              }
            }]
          };

          if (map.getLayer('end')) {
          map.getSource('end').setData(end);
          } else {
            map.addLayer({
              id: 'end',
              type: 'circle',
              includeGeometry: true, //
              source: {
                type: 'geojson',
                data: {
                type: 'FeatureCollection',
                features: [{
                  type: 'Feature',
                  properties: {},
                  geometry: {
                    type: 'Point',
                    coordinates: coords
                  }
                }]
                }
              },
              paint: {
                'circle-radius': 10,
                'circle-color': '#f30'
              }
            });
          }
          getRoute(coords);
          });
    </script>
  </body>
  <!-- JQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</html>
